<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>中油團購商品分享中心</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        :root {
            --blue-btn: #007bff;
            --green-btn: #28a745;
            --bg-color: #f4f7f9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 20px 10px;
        }

        .header {
            text-align: center;
            margin-bottom: 25px;
        }

        .header h1 {
            font-size: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* 泡泡框大卡片設計 */
        .product-list {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .product-card {
            background: #fff;
            border-radius: 20px; /* 更圓潤的泡泡感 */
            box-shadow: 0 8px 24px rgba(0,0,0,0.12); /* 強化陰影 */
            overflow: hidden;
            transition: transform 0.2s;
        }

        /* 圖片放大三倍 (滿版垂直) */
        .img-container {
            width: 100%;
            aspect-ratio: 1 / 1; /* 保持正方形 */
            background: #eee;
        }

        .img-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* 資訊區 */
        .info-container {
            padding: 20px;
        }

        .product-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #222;
            margin: 0 0 10px 0;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* 限制兩行 */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .price-row {
            display: flex;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 12px;
        }

        .original-price {
            font-size: 0.9rem;
            color: #999;
            text-decoration: line-through;
        }

        .group-price {
            font-size: 1.4rem;
            color: #ff4d4f;
            font-weight: 800;
        }

        .product-desc {
            font-size: 0.95rem;
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
            display: -webkit-box;
            -webkit-line-clamp: 3; /* 限制描述為三行 */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* 加大按鈕區 */
        .action-area {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            border: none;
            border-radius: 12px;
            height: 50px; /* 加大高度 */
            font-size: 1.1rem;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            transition: opacity 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            text-decoration: none;
        }

        .btn:active { opacity: 0.8; }

        .btn-blue { background-color: var(--blue-btn); }
        .btn-green { background-color: var(--green-btn); }

        /* 載入中動畫 */
        #loading { text-align: center; color: #666; padding: 50px; }
    </style>
</head>
<body>

    <div class="header">
        <h1>團購素材分享中心</h1>
    </div>

    <div id="loading">讀取商品清單中...</div>
    <div id="product-list" class="product-list"></div>

    <script>
        // 請替換為你的 GAS 部署網址
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyJqZMfT7VnRt-TrfvL9IDsOBNQE6_Ee3tRw3Mrlel4F4In7JVzES4S7BIz44tqf24F/exec"; 

        async function initLIFF() {
            try {
                await liff.init({ liffId: "你的_LIFF_ID" });
                if (!liff.isLoggedIn()) {
                    liff.login();
                } else {
                    fetchProducts();
                }
            } catch (err) {
                console.error("LIFF 初始化失敗", err);
            }
        }

        async function fetchProducts() {
            try {
                const response = await fetch(GAS_URL);
                const data = await response.json();
                renderProducts(data);
                document.getElementById('loading').style.display = 'none';
            } catch (err) {
                document.getElementById('loading').innerText = "連線失敗，請稍後再試";
            }
        }

        function renderProducts(products) {
            const container = document.getElementById('product-list');
            // 注意：這裡的 index 需對應你 Sheets 的欄位順序
            // A: 名稱[0], B: 價格[1], C: 圖片[2], D: 導購連結[3], E: 描述[4], F: 原價[5]
            container.innerHTML = products.map(item => `
                <div class="product-card">
                    <div class="img-container">
                        <img src="${item[2]}" alt="商品圖片">
                    </div>
                    <div class="info-container">
                        <div class="product-title">${item[0]}</div>
                        <div class="price-row">
                            <span class="original-price">NT$ ${item[5] || (parseInt(item[1])*1.5).toFixed(0)}</span>
                            <span class="group-price">NT$ ${item[1]}</span>
                        </div>
                        <div class="product-desc">${item[4] || '暫無產品敘述，請點擊下方連結查看詳情。'}</div>
                        
                        <div class="action-area">
                            <a href="${item[3]}" target="_blank" class="btn btn-blue">前往商品頁</a>
                            <button class="btn btn-green" onclick="shareFlex('${item[0]}', '${item[1]}', '${item[2]}', '${item[3]}')">分享素材</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function shareFlex(name, price, img, link) {
            if (!liff.isApiAvailable('shareTargetPicker')) {
                alert("請在手機版 LINE 中使用分享功能");
                return;
            }

            liff.shareTargetPicker([{
                "type": "flex",
                "altText": "【限定團購】" + name,
                "contents": {
                  "type": "bubble",
                  "hero": {
                    "type": "image",
                    "url": img,
                    "size": "full",
                    "aspectRatio": "20:13",
                    "aspectMode": "cover"
                  },
                  "body": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      { "type": "text", "text": name, "weight": "bold", "size": "xl", "wrap": true },
                      {
                        "type": "box",
                        "layout": "baseline",
                        "contents": [
                          { "type": "text", "text": "團購價", "color": "#aaaaaa", "size": "sm", "flex": 2 },
                          { "type": "text", "text": "NT$ " + price, "weight": "bold", "size": "xl", "color": "#ff4d4f", "flex": 5 }
                        ],
                        "margin": "md"
                      }
                    ]
                  },
                  "footer": {
                    "type": "box",
                    "layout": "vertical",
                    "contents": [
                      {
                        "type": "button",
                        "action": { "type": "uri", "label": "立即訂購", "uri": link },
                        "style": "primary",
                        "color": "#28a745"
                      }
                    ]
                  }
                }
            }]).then(() => {
                console.log("分享成功");
            }).catch(err => console.error(err));
        }

        initLIFF();
    </script>
</body>
</html>
